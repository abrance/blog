<html>
<head>
  <title>Evernote Export</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/602263 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="3384"/>
<h1>以太坊数据上链</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2020/10/9 9:43</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2020/10/16 17:24</i></td></tr>
<tr><td><b>作者：</b></td><td><i>DaguguJ</i></td></tr>
</table>
</div>
<br/>

<div>
<span><div><div><br/></div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 220px;"></col><col style="width: 1028px;"></col></colgroup><tbody><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div><br/></div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><ul><li><div>why</div></li><ul><li><div>部署数据上链的业务，熟悉区块链（以太坊）的一般流程，针对新手快速入门区块链（以太坊）</div></li><li><div>本人做的所有教程都有两个目的 备忘、希望有人指正</div></li></ul><li><div>how</div></li><ul><li><div>搭建 流行的以太坊 私链服务器，实现数据上链，并将一系列流程 记录</div></li></ul><li><div>what</div></li><ul><li><div>初次 实现数据上链 笔记 </div></li></ul></ul></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div>查阅的资料</div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><ul><li><div>链社区</div></li><li><div><a href="https://learnblockchain.cn/">https://learnblockchain.cn/</a></div></li><li><div>solidity 教程</div></li><li><div><a href="https://www.tryblockchain.org/Solidity-AccessorFunction-%E8%AE%BF%E9%97%AE%E5%87%BD%E6%95%B0.html">https://www.tryblockchain.org/Solidity-AccessorFunction-%E8%AE%BF%E9%97%AE%E5%87%BD%E6%95%B0.html</a></div></li><li><div><a href="https://dev.fo/zh-cn/guide/smart-contract-database.html">https://dev.fo/zh-cn/guide/smart-contract-database.html</a></div></li><li><div><a href="https://learnblockchain.cn/docs/solidity/layout-of-source-files.html#import">https://learnblockchain.cn/docs/solidity/layout-of-source-files.html#import</a></div></li><li><div>eth 控制台命令</div></li><li><div><a href="https://blog.51cto.com/12880687/2083802">https://blog.51cto.com/12880687/2083802</a></div></li><li><div><a href="https://www.jianshu.com/p/9fa31e4cdf4d">https://www.jianshu.com/p/9fa31e4cdf4d</a></div></li><li><div>保存数据</div></li><li><div><a href="https://www.cnblogs.com/tinyxiong/p/8084477.html">https://www.cnblogs.com/tinyxiong/p/8084477.html</a></div></li><li><div>智能合约 编译部署</div></li><li><div><a href="https://blog.csdn.net/fpcc/article/details/82746442">https://blog.csdn.net/fpcc/article/details/82746442</a></div></li><li><div>python调接口</div></li><li><div><a href="http://blog.hubwiz.com/2018/08/21/ethereum-python-json-rpc/">http://blog.hubwiz.com/2018/08/21/ethereum-python-json-rpc/</a></div></li></ul></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><br/></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><ul><li><div>不足：</div></li><ul><li><div>此文难以阅读，描述和实例文件 跨度大，需要C-f 查找关键字</div></li></ul></ul></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div><br/></div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div>涉及语言</div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><ul><li><div>python</div></li></ul><ul><li><div>solidity</div></li></ul></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div>准备工作</div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><ul><li><div>一台香港服务器 debian系统</div></li><li><div><br/></div></li><li><div>nodejs安装</div></li><ul><li><div>npm 包</div></li></ul><li><div>git安装</div></li><li><div>python3 安装</div></li><li><div>geth 安装</div></li><li><div>go 安装</div></li></ul></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div><br/></div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div>genesis.json</div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><div><span style="color: unset; font-family: unset; font-size: unset;">存储基本配置信息和额外配置信息，在写脚本 时可以直接导入文件内容（实例下面）</span><br/></div></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div>geth 启动服务参数</div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div>geth 连接服务</div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><ul><li><div>geth attach <a href="http://localhost:8545/">http://localhost:8545</a>    # 一般是这个端口 rpc连接</div></li><li><div>geth attach  geth attach ipc:/data/gethdata/geth.ipc    # ipc 连接</div></li><li><div>...    # websocket 连接</div></li></ul></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div>geth 命令行操作</div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><ul style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px 0px 0px 40px; border: 1px solid transparent; color: rgb(0, 0, 0); font-family: Consolas; font-size: medium; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><li style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px; border: 1px solid transparent;"><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;"><span style="box-sizing: border-box; -webkit-tap-highlight-color: transparent;">eth.accounts</span></div></li><li style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px; border: 1px solid transparent;"><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;"><span style="box-sizing: border-box; -webkit-tap-highlight-color: transparent;">查看所有账户</span></div></li><li style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px; border: 1px solid transparent;"><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;"><span style="box-sizing: border-box; -webkit-tap-highlight-color: transparent;">eth.getBalance() 查看某一账户财产</span></div></li><li><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;">eth.coinbase</div></li><li><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;"><br/></div></li></ul><ul style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px 0px 0px 40px; border: 1px solid transparent; color: rgb(0, 0, 0); font-family: Consolas; font-size: medium; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><li><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;">miner.start()</div></li><li><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;">miner.stop()</div></li><li><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;">...</div></li><li style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px; border: 1px solid transparent;"><div style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;"><span style="box-sizing: border-box; -webkit-tap-highlight-color: transparent;">exit    退出</span></div></li></ul></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div><br/></div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div>solc 编译sol文件（不智能）</div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><ul><li><div>安装</div></li><ul><li><div>npm install -g solc</div></li></ul><li><div>编译</div></li><ul><li><div>solcjs storage.sol --bin --abi --optimize -o ./    # 编译storage.sol 文件，文件输出到同级目录出现 abi 和 bin文件 bin使用时需要加'0x'</div></li></ul></ul></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div>truffle 进行sol文件的智能编译</div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><ul><li><div>安装truffle</div></li><ul><li><div>npm install -g truffle</div></li></ul><li><div>基本使用</div></li><ul><li><div>mkdir contracts</div></li><li><div>cd contracts</div></li><li><div>truffle init</div></li><li><div>.... 自动建立项目 目录树</div></li><ul><li><div>build contracts migrations test truffle-config.js</div></li><li><div>这里只用到 contracts build两个目录</div></li></ul><li><div>写好一个 sol 文件，放入contracts目录</div></li><li><div>truffle compile</div></li><li><div>这时 build/contracts 出现 同名.json 文件</div></li><li><div>完成，json文件备用，写脚本时、部署合约时使用</div></li></ul></ul></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div><br/></div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div>metamask 使用</div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><ul><li><div>功能</div></li><ul><li><div>连接私链账户</div></li><li><div>连接remix部署智能合约</div></li><li><div>账户内容</div></li><ul><li><div>交易内容</div></li><li><div>修改交易细节</div></li><li><div>导出私钥</div></li><ul><li><div>三点-账户详情-导出私钥</div></li></ul><li><div>合约信息</div></li></ul></ul><li><div>读《精通以太坊》 第二章：以太坊基本概念-MetaMask入门 跟书走一遍流程可以学会 几乎所有内容（除了导出私钥）</div></li></ul></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div>remix 使用</div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><ul><li><div>连接私链 并 部署合约</div></li><ul><li><div>deploy &amp; run transaction-environment-injected web3 弹窗输入连接地址</div></li><li><div>选择有钱的账户</div></li><li><div>写sol文件</div></li><li><div>deploy</div></li><li><div>可以看到右下 控制台出现</div></li><ul><li><div>creation of Hello pending...    # 说明正在部署</div></li><li><div>[block:918 txIndex:0]</div></li><li><div>from: 0xCcD...965Ecto: Hello.(constructor)value: 1 weidata: 0x608...00000logs: 0hash: 0xf09...66a0b    # 部署成功</div></li></ul><li><div>服务器日志中也可以看到</div></li></ul></ul></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div>python web3.py 来写脚本调用geth</div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><ul><li><div>安装 web3.py</div></li><ul><li><div>pip3 install web3 报错 lru_dict cytoolz 有问题</div></li><li><div><br/></div></li><li><div>git clone https://github.com/ethereum/web3.py.git</div></li><li><div>apt-get install python3-dev    # 不进行这一步可能导致 报错</div></li><li><div>python3.7 setup.py install     # 避免连接错了python3版本</div></li></ul><li><div>web3 使用</div></li><ul><li><div>与pypi 里不同 ？</div></li><ul><li><div>使用web3.utils 报错，无utils，试了一下可以直接使用utils里内容</div></li></ul></ul><li><div>实例</div></li><ul><li><div>部署已编译合约 co.py（源码下面） </div></li></ul></ul></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div><br/></div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div><br/></div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><div><br/></div></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div>tip</div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><ul><li><div>交易</div></li><ul><li><div>metamask 进行交易时，一直pending; 我以为是gasprice问题，加高没用，后来执行 miner.start() 一瞬间完成；不知原因</div></li></ul></ul></td></tr><tr><td style="width: 220px; padding: 8px; border: 1px solid;"><div>总结</div></td><td style="width: 1028px; padding: 8px; border: 1px solid;"><ul><li><div>很多方式可以 交易，数据上链，各种信息查询，但是做完觉得，脚本方式最简单<br/></div></li></ul></td></tr></tbody></table><div><br/></div></div><div>genesis.json</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>{</div><div>    &quot;config&quot;: {</div><div>        &quot;chainId&quot;: 8888,</div><div>        &quot;homesteadBlock&quot;: 0,</div><div>        &quot;daoForkBlock&quot;: 0,</div><div>        &quot;daoForkSupport&quot;: true,</div><div>        &quot;eip150Block&quot;: 0,</div><div>        &quot;eip155Block&quot;: 0,</div><div>        &quot;eip158Block&quot;: 0,</div><div>        &quot;byzantiumBlock&quot;: 0,</div><div>        &quot;constantinopleBlock&quot;: 0,</div><div>        &quot;petersburgBlock&quot;: 0,</div><div>        &quot;ethash&quot;: {},</div><div>        &quot;clique&quot;: {</div><div>            &quot;period&quot;: 5,</div><div>            &quot;epoch&quot;: 30000</div><div>        }</div><div>    },</div><div>    &quot;nonce&quot;: &quot;0x42&quot;,</div><div>    &quot;timestamp&quot;: &quot;0x0&quot;,</div><div>    &quot;extraData&quot;:  &quot;0x11bbe8db4e347b4e8c937c1c8370e4b5ed33adb3db69cbdb7a38e1e50b1b82fa&quot;,</div><div>    &quot;gasLimit&quot;: &quot;0xffffffffffffff&quot;,</div><div>    &quot;difficulty&quot;: &quot;0x1&quot;,</div><div>    &quot;alloc&quot;: {</div><div>        &quot;093f59f1d91017d30d8c2caa78feb5beb0d2cfaf&quot;: {</div><div>            &quot;balance&quot;: &quot;0xffffffffffffffff&quot;</div><div>        },</div><div>        &quot;ddf7202cbe0aaed1c2d5c4ef05e386501a054406&quot;: {</div><div>            &quot;balance&quot;: &quot;0xffffffffffffffff&quot;</div><div>        }</div><div>    }</div><div>}</div></div><div><br/></div><div>co.py</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import requests</div><div>import json</div><div>import web3</div><div>import pprint</div><div>import time</div><div><br/></div><div><br/></div><div>session = requests.Session()</div><div><br/></div><div>method = 'net_version'</div><div>params = []</div><div>requestId = 0  # is automatically incremented at each request</div><div><br/></div><div><br/></div><div>URL = 'http://localhost:8545'  # url of my geth node</div><div>PATH_GENESIS = '/data/gethdata/genesis.json'</div><div>PATH_SC_TRUFFLE = '/data/gethdata/contracts'  # smart contract path</div><div># extracting data from the genesis file</div><div>genesisFile = json.load(open(PATH_GENESIS))</div><div>CHAINID = genesisFile['config']['chainId']</div><div>PERIOD = genesisFile['config']['clique']['period']</div><div>GASLIMIT = int(genesisFile['gasLimit'], 0)</div><div><br/></div><div><br/></div><div>def createJSONRPCRequestObject(_method, _params, _requestId):</div><div>    return {&quot;jsonrpc&quot;: &quot;2.0&quot;,</div><div>            &quot;method&quot;: _method,</div><div>            &quot;params&quot;: _params,  # must be an array [value1, value2, ..., valueN]</div><div>            &quot;id&quot;: _requestId}, _requestId + 1</div><div><br/></div><div><br/></div><div>def postJSONRPCRequestObject(_HTTP_end_point, _jsonRPCRequestObject):</div><div>    _res = session.post(_HTTP_end_point,</div><div>                        json=_jsonRPCRequestObject,</div><div>                        headers={'Content-type': 'application/json'})</div><div><br/></div><div>    return _res.json()</div><div><br/></div><div><br/></div><div><br/></div><div>&quot;&quot;&quot;</div><div>test -- get net_version</div><div>&quot;&quot;&quot;</div><div>payload = {&quot;jsonrpc&quot;: &quot;2.0&quot;,</div><div>           &quot;method&quot;: method,</div><div>           &quot;params&quot;: params,</div><div>           &quot;id&quot;: 1}</div><div>headers = {'Content-type': 'application/json'}</div><div>response = session.post(URL, json=payload, headers=headers)</div><div>print('raw json response: {}'.format(response.json()))</div><div>print('network id: {}'.format(response.json()['result']))</div><div># create persistent HTTP connection</div><div>session = requests.Session()</div><div>w3 = web3.Web3()</div><div>pp = pprint.PrettyPrinter(indent=2)</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div># compile your smart contract with truffle first</div><div>truffleFile = json.load(open(PATH_SC_TRUFFLE + '/build/contracts/AdditionContract.json'))</div><div><br/></div><div><br/></div><div>abi = truffleFile['abi']</div><div>bytecode = truffleFile['bytecode']</div><div><br/></div><div><br/></div><div># 从metamask 地址是账户 中导出 私钥 看metamask 内容</div><div>user = '0xCcDAb94Dd44693BAd4451A4b720d2C2fc0C965Ec'</div><div>private_key = '6aebff48fe70e79113c7d83623a01b412a05329d50cd6aa19e34da53832d6bdf'</div><div><br/></div><div><br/></div><div># get your nonce</div><div>requestObject, requestId = \</div><div>    createJSONRPCRequestObject('eth_getTransactionCount', [user, 'latest'], requestId)</div><div>responseObject = postJSONRPCRequestObject(URL, requestObject)</div><div>myNonce = w3.toInt(hexstr=responseObject['result'])</div><div>print('nonce of address {} is {}'.format(user, myNonce))</div><div><br/></div><div><br/></div><div># create your transaction</div><div># careful with gas price, gas price below the --gasprice option of</div><div># Geth CLI will cause problems. I am running my node with --gasprice '1'</div><div>transaction_dict = {'from': user,</div><div>                    'to': '',  # empty address for deploying a new contract</div><div>                    'chainId': CHAINID,</div><div>                    'gasPrice': w3.toHex(20 * 1),</div><div>                    'gas': w3.toHex(2000000),  # rule of thumb / guess work</div><div>                    'nonce': myNonce,</div><div>                    'data': bytecode}  # no constrctor in my smart contract so bytecode is enough</div><div><br/></div><div><br/></div><div># sign the transaction</div><div>signed_transaction_dict = w3.eth.account.signTransaction(transaction_dict, private_key)</div><div>params = [signed_transaction_dict.rawTransaction.hex()]</div><div><br/></div><div><br/></div><div># send the transacton to your node</div><div>requestObject, requestId = createJSONRPCRequestObject('eth_sendRawTransaction', params, requestId)</div><div>responseObject = postJSONRPCRequestObject(URL, requestObject)</div><div>print(responseObject)</div><div>transactionHash = responseObject['result']</div><div>print('contract submission hash {}'.format(transactionHash))</div><div><br/></div><div><br/></div><div># wait for the transaction to be mined and get the address of the new contract</div><div>while True:</div><div>    requestObject, requestId = createJSONRPCRequestObject('eth_getTransactionReceipt', [transactionHash], requestId)</div><div>    responseObject = postJSONRPCRequestObject(URL, requestObject)</div><div>    receipt = responseObject['result']</div><div>    if receipt is not None:</div><div>        if receipt['status'] == '0x1':</div><div>            contractAddress = receipt['contractAddress']</div><div>            print('newly deployed contract at address {}'.format(contractAddress))</div><div>        else:</div><div>            pp.pprint(responseObject)</div><div>            raise ValueError('transacation status is &quot;0x0&quot;, failed to deploy contract. Check gas, gasPrice first')</div><div>        break</div><div>    time.sleep(PERIOD / 10)</div></div><div><br/></div></span>
</div></body></html> 